<html>

<head>
    <title>Toolbar example for mxGraph</title>
    <meta charset="utf-8">
    <script type="text/javascript">
        mxBasePath = '../src';
    </script>

    <!-- Loads and initializes the library -->
    <script type="text/javascript" src="../src/js/mxClient.js"></script>

    <script type="text/javascript">
        var constants = {
            transparentImage: (mxClient.IS_SVG) ? 'data:image/gif;base64,R0lGODlhMAAwAIAAAP///wAAACH5BAEAAAAALAAAAAAwADAAAAIxhI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC8fyTNf2jef6zvf+DwwKh8Si8egpAAA7' : IMAGE_PATH + '/transparent.gif'
        };

        function main() {

            if (mxClient.isBrowserSupported()) {
                var container = createAbsoluteDiv(document.body);
                container.style.left = '24px';
                container.style.right = '200px';
                container.style.top = '26px';
                container.style.bottom = '0px';
                container.style.backgroundImage = 'url(./editors/images/grid.gif)';
                mxEvent.disableContextMenu(container);

                var tbcontainer = createAbsoluteDiv(document.body);
                tbcontainer.style.left = '0px';
                tbcontainer.style.width = '24px';
                tbcontainer.style.top = '26px';
                tbcontainer.style.bottom = '0px';

                var rightSidebar = createAbsoluteDiv(document.body);
                rightSidebar.style.right = '0px';
                rightSidebar.style.width = '190px';
                rightSidebar.style.top = '26px';
                rightSidebar.style.bottom = '0px';

                var graph = new mxGraph(container);

                graph.dropEnabled = true;
                graph.setConnectable(true);
                graph.setMultigraph(false);
                graph.setHtmlLabels(true);
                graph.setTooltips(true);
                var rubberband = new mxRubberband(graph);

                var toolbox = new mxToolbar(tbcontainer);
                toolbox.enabled = false;
                addToolbarItem('editors/images/swimlane.gif', toolbox, graph, 'shape=swimlane');
                addToolbarItem('editors/images/actor.gif', toolbox, graph, 'shape=ellipse;indicatorShape=actor;verticalLabelPosition=bottom;indicatorWidth=28;indicatorColor=blue;');

                mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);
                graph.isCellEditable = function(cell) {
                    var cellstate = graph.view.getState(cell);
                    if (cellstate != null) {
                        if (cellstate.style == null || cellstate.style[mxConstants.STYLE_SHAPE] == 'ellipse') {
                            return false;
                        }
                    }
                    return mxGraph.prototype.isCellEditable.apply(graph, cell);

                };

                var popupMenuHandler = graph.createPopupMenuHandler();
                popupMenuHandler.factoryMethod = function(menu, cell, evt) {
                    menu.addItem('Item 1', null, function() {
                        alert('Item 1');
                    });

                    menu.addItem('Item 2', null, function() {
                        alert('Item 2');
                    });

                    menu.addSeparator();

                    var submenu1 = menu.addItem('Submenu 1', null, null);

                    menu.addItem('Subitem 1', null, function() {
                        alert('Subitem 1');
                    }, submenu1);
                    menu.addItem('Subitem 1', null, function() {
                        alert('Subitem 2');
                    }, submenu1);
                };

                document.body.appendChild(mxUtils.button('View XML', function(evt) {
                    console.log('evt.x: ' + evt.x + '; evt.type: ' + evt.type);
                    var codec = new mxCodec();
                    var modelxml = codec.encode(graph.model);
                    mxUtils.popup(mxUtils.getPrettyXml(modelxml), true);

                }));

                document.body.appendChild(mxUtils.button('create library', function(evt) {
                    if (!graph.isSelectionEmpty()) {
                        var cells = graph.getSelectionCells();
                        console.log('selection count is: ' + cells.length);
                        var bounds = graph.view.getBounds(cells);
                        var s = graph.view.scale;

                        bounds.x /= s;
                        bounds.y /= s;
                        bounds.width /= s;
                        bounds.height /= s;
                        bounds.x -= graph.view.translate.x;
                        bounds.y -= graph.view.translate.y;

                        console.log('bounds.x: ' + bounds.x + '; bounds.y: ' + bounds.y);
                        addCells(cells, bounds, 'cells.length');
                    } else {
                        mxUtils.error('请选择要设置为模板的那些组件！', 200, true);
                    }

                }));

                function addCells(cells, bounds, evt, title) {
                    cells = graph.cloneCells(mxUtils.sortCells(graph.model.getTopmostCells(cells)));

                    // Translates cells to origin
                    for (var i = 0; i < cells.length; i++) {
                        var geo = graph.getCellGeometry(cells[i]);

                        if (geo != null) {
                            geo.translate(-bounds.x, -bounds.y);
                        }
                    }

                    rightSidebar.appendChild(createItem(cells, bounds.width, bounds.height, title || 'cus', true, false, false));

                }

                function createItem(cells, title, showLabel, showTitle, width, height, allowCellsInserted) {
                    var elt = document.createElement('a');
                    elt.setAttribute('href', 'javascript:void(0);');
                    elt.className = 'geItem';
                    elt.style.overflow = 'hidden';
                    var border = (mxClient.IS_QUIRKS) ? 8 + 2 * ((document.documentMode >= 5) ? 0 : 1) : 2 * 2;
                    elt.style.width = (10 + border) + 'px';
                    elt.style.height = (10 + border) + 'px';
                    elt.style.padding = 1 + 'px';

                    if (mxClient.IS_IE6) {
                        elt.style.border = 'none';
                    }

                    // Blocks default click action
                    mxEvent.addListener(elt, 'click', function(evt) {
                        mxEvent.consume(evt);
                    });

                    createThumb(cells, 10, 10, elt, title, showLabel, showTitle, width, height);

                    return elt;
                }

                function createThumb(cells, width, height, parent, title, showLabel, showTitle, realWidth, realHeight) {
                    graph.labelsVisible = (showLabel == null || showLabel);
                    var fo = mxClient.NO_FO;
                    graph.view.scaleAndTranslate(1, 0, 0);
                    graph.addCells(cells);
                    var bounds = graph.getGraphBounds();
                    var s = Math.floor(Math.min((width - 2 * 10) / bounds.width,
                        (height - 2 * 10) / 10) * 100) / 100;
                    graph.view.scaleAndTranslate(s, Math.floor((width - bounds.width * s) / 2 / s - bounds.x),
                        Math.floor((height - bounds.height * s) / 2 / s - bounds.y));

                    var node = null;

                    // For supporting HTML labels in IE9 standards mode the container is cloned instead
                    if (graph.dialect == mxConstants.DIALECT_SVG) {
                        console.log('create svg!');
                        node = graph.view.getCanvas().ownerSVGElement.cloneNode(true);
                    }
                    // LATER: Check if deep clone can be used for quirks if container in DOM
                    else {
                        node = graph.container.cloneNode(false);
                        node.innerHTML = graph.container.innerHTML;
                    }

                    graph.getModel().clear();
                    mxClient.NO_FO = fo;

                    // Catch-all event handling
                    if (mxClient.IS_IE6) {
                        parent.style.backgroundImage = 'url(' + constants.transparentImage + ')';
                    }

                    node.style.position = 'relative';
                    node.style.overflow = 'hidden';
                    node.style.cursor = 'move';
                    node.style.left = 10 + 'px';
                    node.style.top = 10 + 'px';
                    node.style.width = width + 'px';
                    node.style.height = height + 'px';
                    node.style.visibility = '';
                    node.style.minWidth = '';
                    node.style.minHeight = '';

                    parent.appendChild(node);

                    /*// Adds title for sidebar entries
                    if (this.sidebarTitles && title != null && showTitle != false) {
                        var border = (mxClient.IS_QUIRKS) ? 2 * this.thumbPadding + 2 : 0;
                        parent.style.height = (this.thumbHeight + border + this.sidebarTitleSize + 8) + 'px';

                        var div = document.createElement('div');
                        div.style.fontSize = this.sidebarTitleSize + 'px';
                        div.style.color = '#303030';
                        div.style.textAlign = 'center';
                        div.style.whiteSpace = 'nowrap';

                        if (mxClient.IS_IE) {
                            div.style.height = (this.sidebarTitleSize + 12) + 'px';
                        }

                        div.style.paddingTop = '4px';
                        mxUtils.write(div, title);
                        parent.appendChild(div);
                    }
                    */
                    return bounds;
                }

            } else {
                mxUtils.error('浏览器不支持！', 200, false);
            }

        }


        function addToolbarItem(image, toolbox, graph, style) {
            function funct(graph, evt, cell, x, y) {
                var pt = graph.getPointForEvent(evt);
                console.log('x: ' + x + '; y: ' + y + '; evt.x: ' + evt.x + '; evt.type: ' + evt.type +
                    '; pt.x: ' + pt.x + '; pt.y: ' + pt.y);

                var parent = graph.getDefaultParent();
                var v1 = graph.insertVertex(parent, null, '<b>hello world<b>', x, y, 90, 55.62, style);
                var overlay = new mxCellOverlay(new mxImage('images/connector.gif', 16, 16), 'overlay', mxConstants.ALIGN_LEFT);
                graph.addCellOverlay(v1, overlay);
                overlay.addListener(mxEvent.CLICK, function(sender, mxevt) {
                    console.log('mxevt.name: ' + mxevt.name + '; properties: ' + mxevt.properties);
                });
            }

            var img = toolbox.addMode('rectangle', image, function(evt, cell) {
                console.log('item funct');
            });
            mxUtils.makeDraggable(img, graph, funct);
        }

        function createAbsoluteDiv(parentDom) {
            var div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.overflow = 'hidden';
            parentDom.appendChild(div);
            return div;
        }
    </script>
</head>

<body onload="main()">
</body>

</html>